import random
import csv
import os
with open('omg.csv') as f:
	f_csv = csv.DictReader(f)
	shuliang=0;
	for row in f_csv:
		name=row['Name'];
		print(name);
		year_of_discovery=row['Published'];
		keywords=row['Type']+';'+row['Platform'];
		protocol='ftp';
		proPort='21';
		reference='EDB-ID:'+row['EDB-ID']+';CVE-ID:'+row['CVE-ID'];
		description='';
		owner='ICT';
		type1='two-arms';
		outfile=open('%s.xml'%name,'w');
		outfile.write('<?xml version="1.0" encoding="UTF-8"?>\n');
		outfile.write('<script module="no"><name>'+name+'</name>');
		outfile.write('<year_of_discovery>'+year_of_discovery+'</year_of_discovery>');
		outfile.write('<keywords>'+keywords+'</keywords>');
		outfile.write('<protocol>'+protocol+'</protocol>');
		outfile.write('<reference>'+reference+'</reference>');
		outfile.write('<description>'+description+'</description>');
		outfile.write('<owner>'+owner+'</owner>');
		outfile.write('<type>'+type1+'</type><![CDATA[{\n');
		outfile.write('#author ICT\n');
		outfile.write('my msg = "";\n');
		outfile.write('$targetPort = %s;\n'%proPort);
		IsourcePort=random.randint(15000,50000);
		sourcePort=str(IsourcePort);
		outfile.write('$sourcePort = %s;\n'%sourcePort);
		outfile.write('my $res={msg => ""};\n')
		outfile.write('my($cid_'+sourcePort+'_'+proPort+',$sid_'+sourcePort+'_'+proPort+') = strikeConnect(\'tcp\', $tagIp, $srcIp, $targetPort, $sourcePort, $targetIntf, $sourceIntf);\n');
		outfile.write('if((!$cid_'+sourcePort+'_'+proPort+') || (!strikeConnected($cid_'+sourcePort+'_'+proPort+', 3))){$res->{msg} = "FILTERED BY DUT! can not connect at 1!";return $res;}\n');
		message='';
		j=2;
		s=input('What is the package?	');

		while s != '' :
			for i in range(len(s)) :
					t=ord(s[i]);
					message=message+"%02x"%t;
			message=message+'0d0a';
			l=len(message)/2;
			sender=input('Whose package?(s/c)	');
			times=input('How many times?	');
			times=int(times);
			ci=0;
			while ci < times :
				if sender == 's':
					outfile.write('$msg = pack(\"H*\", \"%s\");\n'%message);
					outfile.write('# message from server\n');
					outfile.write('strikeSend($sid_'+sourcePort+'_'+proPort+', $msg);\n');
					outfile.write('$fromServer = strikeRecv($cid_'+sourcePort+'_'+proPort+', 3, %d);\n'%l);
					outfile.write('if(!$fromServer)\n');
					outfile.write('{$res->{msg} = "FILTERED BY DUT! can not receive from server at %d!";return $res;}\n'%j);
				else :
					outfile.write('$msg = pack(\"H*\", \"%s\");\n'%message);
					outfile.write('# message from client\n');
					outfile.write('strikeSend($cid_'+sourcePort+'_'+proPort+', $msg);\n');
					outfile.write('$fromClient = strikeRecv($sid_'+sourcePort+'_'+proPort+', 3, %d);\n'%l);
					outfile.write('if(!$fromClient)\n');
					outfile.write('{$res->{msg} = "FILTERED BY DUT! can not receive from client at %d!";return $res;}\n'%j);
				ci=ci+1;
				j=j+1;
			message='';
			j=j+1;
			s=input('what is the package?	');
		outfile.write('strikeDisconnect($cid_'+sourcePort+'_'+proPort+');\n');
		outfile.write('$res->{msg}="PASS DUT!";\n');
		outfile.write('return $res;}\n');
		outfile.write(']]></script>\n');
		outfile.close();
		shuliang=shuliang+1;
		prob=input('Mark it?(y/n)	');
		if prob == 'y':
			os.rename('%s.xml'%name,'%s(???).xml'%name);
		ans=input('Continue?(y/n)	');
		if ans == 'n':
			break;
with open('omg.csv','r') as r:  
    lines=r.readlines()  
i=0;
with open('omg.csv','w') as w:  
    for l in lines:  
        if i==0 or i>shuliang :  
        	w.write(l);
        	i=i+1;
        else :
        	i=i+1;



